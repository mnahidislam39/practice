<style>
  .video-carousel-section {
    width: 100%;
  }
  .swiper {
    width: 100%;
    overflow: hidden;
    padding-bottom: 40px;
    position: relative;
  }
  .swiper-wrapper {
    display: flex;
    transition: transform 0.4s ease;
    will-change: transform;
  }
  .swiper-slide {
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    flex-shrink: 0;
    /* margin-right set dynamically via JS */
  }
  .video-wrapper iframe,
  .video-wrapper video,
  .video-wrapper img {
    width: 100%;
    height: 315px;
    display: block;
    object-fit: cover;
  }
  .video-info {
    padding: 15px;
  }
  .video-info h2 {
    font-size: 20px;
    margin-bottom: 10px;
  }
  .video-info p {
    font-size: 14px;
    color: #555;
  }
  .swiper-button-prev, .swiper-button-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: #333;
    background: #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 10;
  }
  .swiper-button-prev {
    left: 10px;
  }
  .swiper-button-next {
    right: 10px;
  }
  .swiper-pagination {
    position: absolute;
    bottom: 10px;
    width: 100%;
    text-align: center;
    user-select: none;
  }
  .swiper-pagination .dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin: 0 5px;
    background: #ccc;
    border-radius: 50%;
    cursor: pointer;
  }
  .swiper-pagination .dot.active {
    background: #333;
  }
</style>

<div id="section-{{ section.id }}" class="video-carousel-section"
     style="
       padding-top: {{ section.settings.padding_top }}px;
       padding-bottom: {{ section.settings.padding_bottom }}px;
       background-color: {{ section.settings.bg_color }};
     ">
  <div class="container-fluid">
    <div class="swiper video-swiper"
         data-slides="{{ section.settings.slides_per_row }}"
         data-show-arrows="{{ section.settings.show_arrows }}"
         data-show-pagination="{{ section.settings.show_pagination }}"
         data-slide-gap="{{ section.settings.slide_gap }}"
         >
      <div class="swiper-wrapper">
        {% for block in section.blocks %}
          <div class="swiper-slide">
            <div class="video-wrapper">
              {% if block.settings.override_image %}
                <img src="{{ block.settings.override_image | image_url: width: 1200 }}" alt="{{ block.settings.title | escape }}">
              {% else %}
                {% case block.settings.video_source %}
                  {% when "youtube" %}
                    <iframe 
                      src="https://www.youtube.com/embed/{{ block.settings.video_link | split: 'v=' | last }}" 
                      title="{{ block.settings.title | escape }}" 
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                      allowfullscreen></iframe>
                  {% when "vimeo" %}
                    <iframe 
                      src="https://player.vimeo.com/video/{{ block.settings.video_link | split: '/' | last }}" 
                      title="{{ block.settings.title | escape }}" 
                      allow="autoplay; fullscreen; picture-in-picture" 
                      allowfullscreen></iframe>
                  {% when "mp4" %}
                    {% if block.settings.uploaded_video %}
                      <video controls>
                        <source src="{{ block.settings.uploaded_video }}" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                    {% else %}
                      <p>No MP4 video provided</p>
                    {% endif %}
                {% endcase %}
              {% endif %}
            </div>
            <div class="video-info">
              <h2>{{ block.settings.title }}</h2>
              <p>{{ block.settings.description }}</p>
              <a href="{{ block.settings.btnUrl }}" class="m-button m-button--primary"> {{ block.settings.btnText }} </a>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if section.settings.show_arrows %}
        <div class="swiper-button-prev">&#10094;</div>
        <div class="swiper-button-next">&#10095;</div>
      {% endif %}
      
      {% if section.settings.show_pagination %}
        <div class="swiper-pagination"></div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  function initVanillaSwiper(swiperEl) {
    if (!swiperEl) return;

    const slidesPerViewDefault = parseInt(swiperEl.dataset.slides) || 3;
    const showArrows = swiperEl.dataset.showArrows === 'true';
    const showPagination = swiperEl.dataset.showPagination === 'true';
    const slideGap = parseInt(swiperEl.dataset.slideGap) || 20;

    const wrapper = swiperEl.querySelector('.swiper-wrapper');
    const slides = swiperEl.querySelectorAll('.swiper-slide');
    const totalSlides = slides.length;

    let slidesPerView = 1;
    let currentIndex = 0;

    function updateSlidesPerView() {
      const width = window.innerWidth;
      if (width >= 1024) {
        slidesPerView = slidesPerViewDefault;
      } else if (width >= 768) {
        slidesPerView = Math.min(slidesPerViewDefault, 2);
      } else {
        slidesPerView = 1;
      }
    }

    updateSlidesPerView();

    function setSlideWidthsAndGap() {
      const slideWidthPercent = (100 / slidesPerView);
      slides.forEach((slide, index) => {
        slide.style.flexBasis = slideWidthPercent + '%';
        slide.style.marginRight = slideGap + 'px';
      });
    }

    setSlideWidthsAndGap();

    function updateSliderPosition() {
      if (currentIndex < 0) currentIndex = 0;
      if (currentIndex > totalSlides - slidesPerView) currentIndex = totalSlides - slidesPerView;
      if (currentIndex < 0) currentIndex = 0;

      const translateX = -(currentIndex * (100 / slidesPerView) + currentIndex * (slideGap / swiperEl.clientWidth) * 100);
      wrapper.style.transform = `translateX(${translateX}%)`;

      updatePagination();
      updateButtons();
    }

    const prevBtn = swiperEl.querySelector('.swiper-button-prev');
    const nextBtn = swiperEl.querySelector('.swiper-button-next');

    function updateButtons() {
      if (!showArrows) return;
      if (currentIndex <= 0) {
        prevBtn.style.visibility = 'hidden';
      } else {
        prevBtn.style.visibility = 'visible';
      }
      if (currentIndex >= totalSlides - slidesPerView) {
        nextBtn.style.visibility = 'hidden';
      } else {
        nextBtn.style.visibility = 'visible';
      }
    }

    if (showArrows) {
      prevBtn.addEventListener('click', () => {
        currentIndex--;
        updateSliderPosition();
      });

      nextBtn.addEventListener('click', () => {
        currentIndex++;
        updateSliderPosition();
      });
    }

    const paginationEl = swiperEl.querySelector('.swiper-pagination');

    function updatePagination() {
      if (!showPagination || !paginationEl) return;
      paginationEl.innerHTML = '';

      const pageCount = totalSlides - slidesPerView + 1;
      for (let i = 0; i < pageCount; i++) {
        const dot = document.createElement('span');
        dot.classList.add('dot');
        if (i === currentIndex) dot.classList.add('active');
        dot.addEventListener('click', () => {
          currentIndex = i;
          updateSliderPosition();
        });
        paginationEl.appendChild(dot);
      }
    }

    if (showPagination) updatePagination();

    window.addEventListener('resize', () => {
      updateSlidesPerView();
      setSlideWidthsAndGap();
      updateSliderPosition();
    });

    updateSliderPosition();
  }

  // Initialize all video-swipers on the page independently
  document.querySelectorAll('.video-swiper').forEach(swiperEl => {
    initVanillaSwiper(swiperEl);
  });
});
</script>

{% schema %}
{
  "name": "Video/Image Carousel",
  "tag": "section",
  "class": "section-video-carousel",
  "settings": [
    {
      "type": "range",
      "id": "slides_per_row",
      "label": "Slides per row (desktop)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "slide_gap",
      "label": "Gap between slides (px)",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show pagination dots",
      "default": true
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (px)",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (px)",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 40
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f9f9f9"
    }
  ],
  "blocks": [
    {
      "type": "video_slide",
      "name": "Video or Image Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "override_image",
          "label": "Override image (optional)",
          "info": "If set, this image will replace the video."
        },
        {
          "type": "select",
          "id": "video_source",
          "label": "Video Source",
          "options": [
            { "value": "youtube", "label": "YouTube" },
            { "value": "vimeo", "label": "Vimeo" },
            { "value": "mp4", "label": "MP4 Upload" }
          ],
          "default": "youtube"
        },
        {
          "type": "text",
          "id": "video_link",
          "label": "YouTube or Vimeo Link",
          "default": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          "info": "Paste a full YouTube or Vimeo URL. Ignored for MP4 uploads."
        },
        {
          "type": "url",
          "id": "uploaded_video",
          "label": "MP4 Video File",
          "info": "Upload an MP4 file from Shopify files. Only used if 'MP4 Upload' is selected."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Slide Title",
          "default": "Sample Title"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Slide Description",
          "default": "This is a sample description for the carousel item."
        },
        {
          "type": "textarea",
          "id": "btnText",
          "label": "Button Text",
          "default": "View More"
        },
        {
          "type": "url",
          "id": "btnUrl",
          "label": "Button Link"
        }
      ]
    }
  ],
  "max_blocks": 10,
  "presets": [
    {
      "name": "Video/Image Carousel",
      "category": "Media",
      "settings": {
        "slides_per_row": 3,
        "slide_gap": 20,
        "show_arrows": true,
        "show_pagination": true
      },
      "blocks": [
        {
          "type": "video_slide"
        }
      ]
    }
  ]
}
{% endschema %}
